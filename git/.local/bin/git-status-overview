#!/usr/bin/env zsh

{
  command git rev-parse --is-inside-work-tree &>/dev/null \
    && [[ "$(command git rev-parse --show-toplevel)" == "$PWD" ]]
} || return 0

local output num_changes
output=$(git pretty-status $@)

[[ -n "$output" ]] && num_changes=$(print "$output" | wc -l) || num_changes=0

if (( $num_changes == 0 )); then
  print "$output"
  return 0
fi

local num_lines=$(tput lines)
local max_changes=$((($num_lines - (($(tput lines) / 4) * 3))))

if (( $num_changes > $max_changes )); then
  print "$output" | head -$max_changes
  print -P -- "%245F# ... (%{$((($num_changes - $max_changes + 1)))%} more changes%)%f"
else
  print "$output"
fi
